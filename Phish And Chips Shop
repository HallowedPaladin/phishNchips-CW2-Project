import json

# Load inventory from file
def load_inventory(filename):
    try: #opens the inventory for the other functions to access
        with open(filename, "r") as file:
            return json.load(file)
    except FileNotFoundError:
        print("No existing inventory found. Starting with empty inventory.")
        return [] #error and returns empty list if no file is found

# Save inventory to file
def save_inventory(filename, inventory):
    with open(filename, "w") as file:
        json.dump(inventory, file, indent=4)
    print("Changes saved successfully.")

def adding_stock(inventory):
    item_name = input("Please input the name of the stock you wish to add: ")
    pricing = float(input("Please input the price: "))
    item_category = input("Please input the category: ")
    stock_quantity = int(input("Please input the quantity: "))

    while True:
        i_d = input("Please input the items ID: ").lower()
        if any(item["id"] == i_d for item in inventory):
            print("That ID is taken, please choose a different one")
        else:
            break 

    inventory.append({
        "name": item_name,
        "price": pricing,
        "id": i_d,
        "category": item_category,
        "quantity": stock_quantity
    })

    print("Item added successfully.")

def print_table_std_lib(headers, data):
    if not data: return
    col_widths = [len(h) for h in headers]
    for row in data:
        for i, cell in enumerate(row):
            if len(str(cell)) > col_widths[i]: 
                col_widths[i] = len(str(cell))
    col_widths = [w + 2 for w in col_widths] 
    format_string = "| " + " | ".join([f"{{:<{w}}}" for w in col_widths]) + " |" 
    separator = "-" * (sum(col_widths) + (len(col_widths) * 3) + 1) 
    print(separator)
    print(format_string.format(*headers))
    print(separator)
    for row in data:
        print(format_string.format(*[str(c) for c in row]))
    print(separator)

def view_inventory(inventory):
    print("\n-- Current Inventory --")
    headers = ["ID", "Name", "Price (£)", "Quantity", "Category"]
    table_data = []
    for item in inventory:
        table_data.append([
            item['id'],
            item['name'],
            f"{item['price']:.2f}",
            item['quantity'],
            item['category']
        ])
    
    print_table_std_lib(headers, table_data)

def update_inventory(inventory):
    item_id = input("Enter the item ID to update: ").lower()

    for item in inventory:
        if item["id"] == item_id:
            print("\nLeave blank to keep the current value.")

            new_name = input(f'New name ({item["name"]}): ')
            new_price = input(f'New price (£{item["price"]}): ')
            new_quantity = input(f'New quantity ({item["quantity"]}): ')
            new_category = input(f'New category ({item["category"]}): ')

            if new_name != "":
                item["name"] = new_name

            if new_price != "":
                try:
                    item["price"] = float(new_price)
                except ValueError:
                    print("Invalid price. Price not updated.")

            if new_quantity != "":
                try:
                    item["quantity"] = int(new_quantity)
                except ValueError:
                    print("Invalid quantity. Quantity not updated.")

            if new_category != "":
                item["category"] = new_category.lower()

            print("\nItem updated successfully.")
            return True

    print("\nItem ID not found.")
    return False

def low_stock_check(inventory):
    print("\nLow stock items (quantity below 6):")
    print("-" * 40)

    found = False

    for item in inventory:
        if item["quantity"] < 6:
            print(f'{item["id"]} | {item["name"]} | Qty: {item["quantity"]} | LOW STOCK')
            found = True

    if not found:
        print("No items are currently low in stock.")

def search(inventory):
    found = False
    search_by = input("What would you like to search by: ID, Name, Price, Quantity: ")

    if search_by.lower() == "id":
        search_id = input("Enter the ID of an item: ").lower()
        for item in inventory:
            if item["id"] == search_id:
                found = True
                price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{price:.2f} Quantity: {item['quantity']}")

    elif search_by.lower() == "name":
        name = input("Enter the name of an item: ")
        for item in inventory:
            if item["name"] == name.lower():
                found = True
                price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{price:.2f} Quantity: {item['quantity']}")

    elif search_by.lower() == "price":
        price = float(input("Enter the price of an item: "))
        for item in inventory:
            if item["price"] == price:
                found = True
                item_price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{item_price:.2f} Quantity: {item['quantity']}")

    elif search_by.lower() == "quantity":
        quantity = int(input("Enter the quantity of an item: "))
        for item in inventory:
            if item["quantity"] == quantity:
                found = True
                price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{price:.2f} Quantity: {item['quantity']}")

    else:
        print("Invalid input")

    if not found:
        print("Item not found")

# Main program
fileName = "inventory.json"

# Load inventory at startup
inventory = load_inventory(fileName)
print("Inventory loaded successfully!")

exit = False

while not exit:
    action = input("\nWhich of the following would you like to do: Add Item, View Stock, Update Item, Search, Save & Exit: ")

    if action.lower() == "add item":
        adding_stock(inventory)
        save_inventory(fileName, inventory)  # Auto-save after adding
        

    elif action.lower() == "view stock":
        view_inventory(inventory)

    elif action.lower() == "update item":
        if update_inventory(inventory):
            save_inventory(fileName, inventory)  # Auto-save after successful update
        low_stock_check(inventory)

    elif action.lower() == "search":
        search(inventory)

    elif action.lower() == "save & exit" or action.lower() == "exit":
        save_inventory(fileName, inventory)  # Final save before exiting
        print("Your changes have been saved. Have a nice day!")
        exit = True

    else:
        print("Invalid input")