import json


def load_inventory(filename):
    try: #opens the inventory for the other functions to access
        with open(filename, "r") as file:
            return json.load(file)
    except FileNotFoundError:
        print("No existing inventory found. Starting with empty inventory.")
        return [] #error and returns empty list if no file is found


def save_inventory(filename, inventory):
    with open(filename, "w") as file: #writes all changes made to the file
        json.dump(inventory, file, indent=4)
    print("Changes saved successfully.")

def adding_stock(inventory):
    item_name = input("Please input the name of the stock you wish to add: ")
    pricing = float(input("Please input the price: "))
    item_category = input("Please input the category (mains, sides, drinks): ")
    stock_quantity = int(input("Please input the quantity: "))

    while True:
        i_d = input("Please input the items ID: ").lower()
        if any(item["id"] == i_d for item in inventory):
            print("That ID is in use, please choose a different one")
        else:
            break 

    inventory.append({
        "name": item_name,
        "price": pricing,
        "id": i_d,
        "category": item_category,
        "quantity": stock_quantity
    })

    print("Item added successfully.")

def print_table_std_lib(headers, table_data):
    if not table_data: return
    col_widths = [len(h) for h in headers]
    for row in table_data:
        for i, cell in enumerate(row):
            if len(str(cell)) > col_widths[i]: 
                col_widths[i] = len(str(cell))
    col_widths = [w + 2 for w in col_widths] 
    format_string = "| " + " | ".join([f"{{:<{w}}}" for w in col_widths]) + " |" 
    separator = "-" * (sum(col_widths) + (len(col_widths) * 3) + 1) 
    print(separator)
    print(format_string.format(*headers))
    print(separator)
    for row in table_data:
        print(format_string.format(*[str(c) for c in row]))
    print(separator)

def view_inventory(inventory):
    print("\n-- Current Inventory --")
    headers = ["ID", "Name", "Price (£)", "Quantity", "Category"]
    table_data = []
    for item in inventory:
        table_data.append([
            item['id'],
            item['name'],
            f"{item['price']:.2f}",
            item['quantity'],
            item['category']
        ])
    
    print_table_std_lib(headers, table_data)

def update_item(inventory, product_id):
    product_id = int(product_id)  # Ensure comparison matches string IDs
    for item in inventory:
        if item["id"] == product_id:
            print(f"Item found: {item['name']}")

            # Update name
            selection = input("Do you want to update this item's name? Y or N: ")
            if selection.lower() == "yes" or selection.lower() == "y":
                newName = input("Please enter the item's new name: ")
                item["name"] = newName
                print(f"Name updated to {item['name']}.")

            # Update price
            selection = input("Do you waupnt to update this item's price? Y or N: ")
            if selection.lower() == "yes" or selection.lower() == "y":
                newPrice = float(input("Please enter new price: "))
                item["price"] = newPrice
                print(f"Price updated to £{item['price']:.2f}.")

            # Update quantity
            selection = input("Do you want to update this item's amount of stock? Y or N: ")
            if selection.lower() == "yes" or selection.lower() == "y":
                amount = int(input("Please enter an amount to update stock by: "))
                item["quantity"] += amount
                print(f"New quantity: {item['quantity']}")

            return True  # Found and updated

    # If loop finishes without returning
    print("This product ID is not valid.")
    return False

def low_stock_check(inventory):
    print("\nLow stock items (quantity below 6):")
    print("-" * 40)

    found = False

    for item in inventory:
        if item["quantity"] < 6:
            print(f'{item["id"]} | {item["name"]} | Qty: {item["quantity"]} | LOW STOCK')
            found = True

    if not found:
        print("No items are currently low in stock.")

def search(inventory):
    found = False
    search_by = input("What would you like to search by: ID, Name, Price, Quantity: ")

    if search_by.lower() == "id":
        search_id = input("Enter the ID of an item: ").lower()
        for item in inventory:
            if item["id"] == search_id:
                found = True
                price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{price:.2f} Quantity: {item['quantity']}")

    elif search_by.lower() == "name":
        name = input("Enter the name of an item: ")
        for item in inventory:
            if item["name"] == name.lower():
                found = True
                price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{price:.2f} Quantity: {item['quantity']}")

    elif search_by.lower() == "price":
        price = float(input("Enter the price of an item: "))
        for item in inventory:
            if item["price"] == price:
                found = True
                item_price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{item_price:.2f} Quantity: {item['quantity']}")

    elif search_by.lower() == "quantity":
        quantity = int(input("Enter the quantity of an item: "))
        for item in inventory:
            if item["quantity"] == quantity:
                found = True
                price = item["price"]
                print("Item found, details below:")
                print(f"ID: {item['id']} Name: {item['name']} Price: £{price:.2f} Quantity: {item['quantity']}")

    else:
        print("Invalid input")

    if not found:
        print("Item not found")

# Main program
fileName = "inventory.json"

# Load inventory at startup
inventory = load_inventory(fileName)
print("Inventory loaded successfully!")

exit = False

while not exit:
    action = input("\nWhich of the following would you like to do: Add Item, View Stock, Update Item, Search, Save & Exit: ")

    if action.lower() == "add item":
        adding_stock(inventory)
        save_inventory(fileName, inventory)  
        

    elif action.lower() == "view stock":
        view_inventory(inventory)

    elif action.lower() == "update item":
        product_id = int(input("Please enter the product ID of the item you wish to update: "))
        if update_item(inventory, product_id):
            save_inventory(fileName, inventory)  # Auto-save after successful update
        low_stock_check(inventory)

    elif action.lower() == "search":
        search(inventory)

    elif action.lower() == "save & exit" or action.lower() == "exit" or action.lower() == 'save':
        save_inventory(fileName, inventory)  
        exit = True

    else:
        print("Invalid input")